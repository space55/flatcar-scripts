From 7b3f9900c2323331a3031600fa570ec56ee189e6 Mon Sep 17 00:00:00 2001
From: Krzesimir Nowak <knowak@microsoft.com>
Date: Wed, 28 Feb 2024 15:41:46 +0100
Subject: [PATCH 19/23] sysext: Actually fail the whole operation if sd-merge
 worker failed

This also fixes a wrong merge failure check.
---
 src/sysext/sysext.c | 3 ++-
 1 file changed, 2 insertions(+), 1 deletion(-)

diff --git a/src/sysext/sysext.c b/src/sysext/sysext.c
index fe01e9dac3..731467d13f 100644
--- a/src/sysext/sysext.c
+++ b/src/sysext/sysext.c
@@ -1729,9 +1729,10 @@ static int merge(ImageClass image_class,
         r = wait_for_terminate_and_check("(sd-merge)", pid, WAIT_LOG_ABNORMAL);
         if (r < 0)
                 return r;
-
         if (r == 123) /* exit code 123 means: didn't do anything */
                 return 0;
+        if (r > 0)
+                return log_error_errno(SYNTHETIC_ERRNO(ENXIO), "Failed to merge hierarchies");
 
         r = need_reload(image_class, hierarchies, no_reload);
         if (r < 0)
-- 
2.34.1

